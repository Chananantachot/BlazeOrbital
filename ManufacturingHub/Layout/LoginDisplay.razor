@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using BlazeOrbital.ManufacturingHub.Data
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IConfiguration Configuration

<AuthorizeView>
    <Authorized>
        <button class="authbutton flex items-center relative px-3 py-1 text-left" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
            <div class="bg-blue-500 text-lg  font-bold rounded-full w-8 h-8 flex justify-center items-center mr-2">
                <span style="margin-top: -2px;">@(context.User.Identity?.Name?.Substring(0, 1).ToUpper())</span>
            </div>

            @context.User.Identity?.Name
     
            <svg class="fill-current h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
            <path fill="white" d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
            </svg>
        
             <div class="py-1" role="none">
                <div class="user-menu absolute mt-2 top-9  right-0 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 text-gray-700">
                    <a href="@(Configuration["BackendOrigin"])/Identity/Account/Manage" class="hover:bg-gray-200 px-4 py-2 text-sm block" role="menuitem" tabindex="-1">My profile</a>
                    <button @onclick="BeginSignOut" class="hover:bg-gray-200 block px-4 py-2 text-sm text-left block w-full" role="menuitem" tabindex="-1">Log out</button>
                </div>
             </div>
        </button>
    </Authorized>
    <NotAuthorized>
        <a class="authbutton" href="@(Configuration["BackendOrigin"])/Identity/Account/Register">Register</a>
        <a class="authbutton" href="authentication/login">Log in</a>
    </NotAuthorized>
    <Authorizing>
        <a class="authbutton">Authorizing...</a>
    </Authorizing>
</AuthorizeView>

@code{
    private async Task BeginSignOut(MouseEventArgs args)
    {
        Navigation.NavigateToLogout("authentication/logout");
        await JS.InvokeVoidAsync("localStorage.removeItem", OfflineAccountClaimsPrincipalFactory.OfflineClaimsKey);
        Navigation.NavigateTo("authentication/logout",true,true);
    }
}
